<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="The Freedom Compass - Your personal financial command center. Track income, expenses, investments, and build your path to financial freedom."
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>The Freedom Compass - Financial Dashboard</title>
    
    <!-- 📊 GOOGLE ANALYTICS 4 - Mission-Critical Tracking -->
    <!-- SETUP INSTRUCTIONS:
         1. Go to https://analytics.google.com/
         2. Create new GA4 property for "The Freedom Compass"
         3. Get your Measurement ID (format: G-XXXXXXXXXX)
         4. Replace "G-XXXXXXXXXX" below with your actual ID
    -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R2943ZZYSK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      // 🎯 Initialize GA4 with enhanced tracking
      gtag('config', 'G-R2943ZZYSK', {
        'send_page_view': true,
        'anonymize_ip': true, // Privacy compliance
        'cookie_flags': 'SameSite=None;Secure'
      });
      
      // 🔧 Make gtag globally accessible for event tracking
      window.gtag = gtag;
    </script>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <script>
      // 🔧 PREMIUM MOBILE KEYBOARD FIX - Viewport restoration without scroll-to-top
      (function() {
        // Set CSS variable for viewport height (fixes iOS Safari keyboard issue)
        function setVH() {
          let vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Set on load
        setVH();
        
        // Update on resize
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', setVH);
        
        // 🎯 NEW: ENHANCED Visual Viewport API for ultra-smooth keyboard handling
        // 🔥 ULTRA-AGGRESSIVE KEYBOARD FIX - Works everywhere!
        if (window.visualViewport) {
          let previousHeight = window.visualViewport.height;
          let keyboardCloseTimeout;
          
          window.visualViewport.addEventListener('resize', () => {
            const currentHeight = window.visualViewport.height;
            const heightDifference = currentHeight - previousHeight;
            
            // Clear any pending keyboard close handlers
            if (keyboardCloseTimeout) {
              clearTimeout(keyboardCloseTimeout);
            }
            
            // Keyboard is CLOSING (viewport getting bigger)
            if (heightDifference > 50) { // ULTRA: 50px threshold (was 100px)
              keyboardCloseTimeout = setTimeout(() => {
                // ULTRA: Triple reflow + viewport restore
                const currentScroll = window.scrollY || document.documentElement.scrollTop;
                
                // Force multiple reflows to eliminate gap
                for (let i = 0; i < 3; i++) {
                  document.body.offsetHeight;
                  void document.body.offsetWidth;
                }
                
                // Restore scroll position
                if (currentScroll > 0) {
                  window.scrollTo({
                    top: currentScroll,
                    behavior: 'auto'
                  });
                }
                
                // Update viewport height
                setVH();
                
                // Final reflow in next frame
                requestAnimationFrame(() => {
                  document.body.offsetHeight;
                  setVH();
                });
              }, 50); // ULTRA: 50ms (was 80ms)
            }
            // ULTRA: Also trigger on ANY height change after short delay
            else if (Math.abs(heightDifference) > 10) {
              keyboardCloseTimeout = setTimeout(() => {
                setVH();
                document.body.offsetHeight;
              }, 100);
            }
            
            previousHeight = currentHeight;
          });
          
          // ULTRA: Also listen for blur events on inputs
          document.addEventListener('focusout', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
              setTimeout(() => {
                setVH();
                document.body.offsetHeight;
              }, 150);
            }
          }, true);
        }
        
        // 🛡️ Fallback for older browsers
        // Only fixes viewport height, no scroll manipulation
        else {
          let resizeTimer;
          window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
              setVH();
            }, 150);
          });
        }
      })();
      
      // 📱 Register Service Worker for PWA functionality
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('📱 SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('📱 SW registration failed: ', registrationError);
            });
        });
      }
    </script>
  </body>
</html>